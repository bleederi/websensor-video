<!--
Copyright 2017 Jesse Nieminen

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>
<html>
	<head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=0.6">
                <link rel="manifest" href="manifest.json" />
		<style>
			body{
				margin: 0;
			}
		</style>
		
	</head>
        <template id="video-view">
                <style>
                :host {
                width: 100vh;
                height: 100vh;
                }
                </style>
        </template>
	<body>
                <button onclick="playPause()">Play/Pause</button>
                <button onclick="rewind()">Rewind</button>
                <video-view>
                        <video id="video1" width="800" height="600" autoplay>
                        <source src="video.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                        </video>
                </video-view>

                <script>
		//TODO: fix rewind by using two video streams, one forward and one backward
                var myVideo = document.getElementById("video1"); 
                var rewinding = false;
                var rw;
                var fps = 30;
                var accel = {x:null, y:null, z:null};
                var prevaccel = {x:null, y:null, z:null};
                var diff = {x:null, y:null, z:null};
                var stepvar = 0;
                var sensorfreq = 30;

                        class Pedometer {
                                constructor() {
                                const sensor = new Accelerometer({ frequency: sensorfreq });
                                sensor.onchange = () => {
                                        prevaccel = accel;
                                        accel = {'x':sensor.x, 'y':sensor.y, 'z':sensor.z};
                                        for (var key in accel)
                                                {
                                                        diff[key] = accel[key] - prevaccel[key];
                                                }
                                        if (this.onchange) this.onchange();
                                };
                                sensor.onactivate = () => {
                                        if (this.onactivate) this.onactivate();
                                }
                                const start = () => sensor.start();
                                Object.assign(this, { start });
                                }
                        }

                        customElements.define('video-view', class extends HTMLElement {
                                constructor() {
                                super();
			        }

                                connectedCallback() {
                                        const sensor = new Pedometer();
                                        sensor.onchange = () => {
                                                //console.log("Change", accel.x, accel.y, accel.z);
                                                console.log(stepvar);
                                                if(magnitude(diff) > (60/sensorfreq))  //with lower sensor frequencies the diff will be bigger
                                                {
                                                        stepvar = stepvar + 1;
                                                }
                                                else
                                                {
                                                        if(stepvar > 0)
                                                        {
                                                        stepvar = stepvar - 1;
                                                        }
                                                }
                                                if(stepvar >= 100)    //step event
                                                {
                                                        console.log("STEP");
                                                        stepvar = 0;
                                                }
                                        }
                                        //sensor.onactivate = () => this.render();
                                        sensor.start();
                                }
                                render() {
                                        console.log("Render");
			        }
                        });

                        function magnitude(vector)      //Calculate the magnitude of a vector
                        {
                        return Math.sqrt(vector.x * vector.x + vector.y * vector.y + vector.z * vector.z);
                        }

                        function playPause() {
                        if (myVideo.paused)
                                myVideo.play(); 
                        else 
                                myVideo.pause(); 
                        } 	

                        function rewind() {
                                if (rewinding)
                                {
	                                rewinding = false;
	                                clearInterval(rw);
                                }
                                else
                                {
	                                rewinding = true;
	                                rw = setInterval(function(){ myVideo.currentTime = myVideo.currentTime - 1/fps; }, 1000/fps);
                                        //myVideo.setAttribute('src', 'video_backwards.mp4');
                                }
                        }			
		</script>
	</body>
</html>

