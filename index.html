<!--
Copyright 2017 Jesse Nieminen

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>
<html lang="en">
	<head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=0.6">
                <link rel="manifest" href="manifest.json" />
		<style>
			body{
				margin: 0;
			}
                   #startbutton {
                        background-color: red;
                        color: #FFFFFF;
                        padding: 15px 32px;
                        border-radius: 10px;
                        margin:10px
                    }
                   #rewindbutton {
                        background-color: blue;
                        color: #FFFFFF;
                        padding: 15px 32px;
                        border-radius: 10px;
                        margin:10px
                    }
		</style>
		
	</head>
        <template id="video-view">
                <style>
                :host {
                width: 100vh;
                height: 100vh;
                }
                </style>
        </template>
	<body>
                <button id="startbutton" onclick="startDemo()">Start demo</button>
<div hidden id="debug">
                <button id="rewindbutton" onclick="rewind()">Rewind</button>
                <button onclick="playButton()">Play</button>
                <button id="play2" hidden>Play2</button>

                <input id="slider_stddev" type="range" min="0.1" max="4" step="0.2" value="3.8">

                Standard deviation threshold: <div id="slider_stddev_amount"></div>

                <input id="slider_stepamt" type="range" min="1" max="5" step="0.5" value="2.5">

                Seconds to capture(delay): <div id="slider_stepamt_amount"></div>

                <input id="slider_bias" type="range" min="0.1" max="1" step="0.1" value="0.9">

                Filter bias: <div id="slider_bias_amount"></div>

                <input id="smoothing_value" type="range" min="0" max="10" step="1" value="5">

                Smoothing value: <div id="smoothing_amount"></div>

                Walking status: <div id="walking_status"></div>

                Rewind status: <div id="rewind_status"></div>

                Standard deviation pct: <div id="stddev"></div>

                Standard deviation of acceleration (no gravity): <div id="stddev_accel"></div>

                Largest FFT index: <div id="fft_index"></div>
</div>
                <video-view id="videoview">
                </video-view>
                <script type="text/javascript" src="fft.js"></script>        <!-- Contains FFT -->
                <script type="text/javascript" src="script.js"></script>        <!-- Contains the step detection algorithm -->
                <script src="three.min.js"></script>
                <script>
                'use strict';

                //Load two video elements, one forward and one backward

                videoF = document.createElement("video");
                videoF.id = "videof";
                videoF.src    = "https://raw.githubusercontent.com/jessenie-intel/websensor-video/master/forward2.mp4";
                videoF.crossOrigin = "anonymous";

                videoB = document.createElement("video");
                videoB.src    = "https://raw.githubusercontent.com/jessenie-intel/websensor-video/master/backward2.mp4";
                videoB.crossOrigin = "anonymous";

                //THREE.js render stuff
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
                camera.target = new THREE.Vector3(0, 0, 0);

                sphere = new THREE.SphereGeometry(100, 100, 40);
                sphere.applyMatrix(new THREE.Matrix4().makeScale(-1, 1, 1));
                video = videoF; //start with the forward video
                video.load();
                videoTexture = new THREE.Texture(video);
                videoTexture.minFilter = THREE.LinearFilter;
                videoTexture.magFilter = THREE.LinearFilter;
                videoTexture.format = THREE.RGBFormat;

                sphereMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: 0.5 } );
                sphereMesh = new THREE.Mesh(sphere, sphereMaterial);
                scene.add(sphereMesh);

                function render() {
                        if( video.readyState === video.HAVE_ENOUGH_DATA ){
                                videoTexture.needsUpdate = true;
                        }
                        if(nosensors)   //for testing
                        {
                                longitude = 0;
                                latitude = 0;
                        }
                        else
                        {
                                longitude = -yaw * 180 / Math.PI;
                                //remove offset, scale to 0-360
                                longitude = longitude - longitudeInitial;
                                if(longitude < 0)
                                {
                                        longitude = longitude + 360;
                                }
                                latitude = roll * 180 / Math.PI - 90;

                        }
                        //Below based on http://www.emanueleferonato.com/2014/12/10/html5-webgl-360-degrees-panorama-viewer-with-three-js/
                        // limiting latitude from -85 to 85 (cannot point to the sky or under your feet)
                        latitude = Math.max(-85, Math.min(85, latitude));
                        // moving the camera according to current latitude (vertical movement) and longitude (horizontal movement)
                        camera.target.x = 500 * Math.sin(THREE.Math.degToRad(90 - latitude)) * Math.cos(THREE.Math.degToRad(longitude));
                        camera.target.y = 500 * Math.cos(THREE.Math.degToRad(90 - latitude));
                        camera.target.z = 500 * Math.sin(THREE.Math.degToRad(90 - latitude)) * Math.sin(THREE.Math.degToRad(longitude));
                        camera.lookAt(camera.target);

                        // Render loop
                        renderer.render(scene, camera);
                        requestAnimationFrame(() => render());
                }

                function playPause()
                {
                        if(stepvar)
                        {
                                walking_status_div.innerHTML = "Walking";
                                play();
                        }
                        else if (!stepvar)
                        {
                                if(!video.paused)
                                {
                                        video.pause();
                                }
                                walking_status_div.innerHTML = "Not walking";
                        }
                }

                        function play()
                        {
                                if(!rewinding)
                                {
                                        var playPromiseF = videoF.play();

                                        // In browsers that don’t yet support this functionality,
                                        // playPromise won’t be defined.
                                        if (playPromiseF !== undefined) {
                                          playPromiseF.then(function() {
                                            // Automatic playback started!
                                                //console.log("Playing");
                                          }).catch(function(error) {
                                                console.log("Promise failed", error.name);
                                            // Automatic playback failed.
                                            // Show a UI element to let the user manually start playback.
                                          var playButton = document.querySelector('#play2');
                                          // The user interaction requirement is met if
                                          // playback is triggered via a click event.
                                          playButton.addEventListener('click', startPlaybackF);
                                          playButton.hidden = false;
                                          });
                                        }
                                }
                                else if(rewinding)
                                {
                                        var playPromiseB = videoB.play();

                                        // In browsers that don’t yet support this functionality,
                                        // playPromise won’t be defined.
                                        if (playPromiseB !== undefined) {
                                          playPromiseB.then(function() {
                                            // Automatic playback started!
                                                //console.log("Playing");
                                          }).catch(function(error) {
                                                console.log("Promise failed", error.name);
                                            // Automatic playback failed.
                                            // Show a UI element to let the user manually start playback.
                                          var playButton = document.querySelector('#play2');
                                          // The user interaction requirement is met if
                                          // playback is triggered via a click event.
                                          playButton.addEventListener('click', startPlaybackB);
                                          playButton.hidden = false;
                                          });
                                        }
                                }         
                        }

                        function playButton()
                        {
                                if(!rewinding)
                                {
                                        if(videoF.paused)
                                        {
                                                var playPromiseF = videoF.play();

                                                // In browsers that don’t yet support this functionality,
                                                // playPromise won’t be defined.
                                                if (playPromiseF !== undefined) {
                                                  playPromiseF.then(function() {
                                                    // Automatic playback started!
                                                        //console.log("Playing");
                                                  }).catch(function(error) {
                                                        console.log("Promise failed", error.name);
                                                    // Automatic playback failed.
                                                    // Show a UI element to let the user manually start playback.
                                                  var playButton = document.querySelector('#play2');
                                                  // The user interaction requirement is met if
                                                  // playback is triggered via a click event.
                                                  playButton.addEventListener('click', startPlaybackF);
                                                  playButton.hidden = false;
                                                  });
                                        }   }
                                        else
                                        {
                                                videoF.pause();                                
                                        }
                                }
                                else if(rewinding)
                                {
                                        if(videoB.paused)
                                        {
                                                var playPromiseB = videoB.play();

                                                // In browsers that don’t yet support this functionality,
                                                // playPromise won’t be defined.
                                                if (playPromiseB !== undefined) {
                                                  playPromiseB.then(function() {
                                                    // Automatic playback started!
                                                        //console.log("Playing");
                                                  }).catch(function(error) {
                                                        console.log("Promise failed", error.name);
                                                    // Automatic playback failed.
                                                    // Show a UI element to let the user manually start playback.
                                                  var playButton = document.querySelector('#play2');
                                                  // The user interaction requirement is met if
                                                  // playback is triggered via a click event.
                                                  playButton.addEventListener('click', startPlaybackB);
                                                  playButton.hidden = false;
                                                  });
                                        }   }
                                        else
                                        {
                                                videoB.pause();                                
                                        }
                                }
                        }

                        customElements.define("video-view", class extends HTMLElement {
                                constructor() {
                                super();
			        }

                                connectedCallback() {
                                        try {
                                        //Initialize sensors
                                        accel_sensor = new Pedometer();
                                        accel_sensor.onchange = () => {
                                        }
                                        accel_sensor.onactivate = () => {
                                        }
                                        accel_sensor.start();
                                        orientation_sensor = new AbsOriSensor();
                                        orientation_sensor.onchange = () => {
                                                roll = orientation_sensor.roll;
                                                pitch = orientation_sensor.pitch;
                                                yaw = orientation_sensor.yaw;
                                                if(!initialoriobtained) //obtain initial longitude
                                                {
                                                        let yawInitial = orientation_sensor.yaw;
                                                        longitudeInitial = -yawInitial * 180 / Math.PI;
                                                        longitudeOffset = longitudeInitial;
                                                        initialoriobtained = true;
                                                }
                                        }
                                        orientation_sensor.onactivate = () => {
                                        }
                                        orientation_sensor.start();
                                        }
                                        catch(err) {
                                                console.log(err.message);
                                                nosensors = true;
                                        }
                                }

                        });

                //Functions related to video playback

                function startPlaybackF() {
                  return videoF.play();
                }
                function startPlaybackB() {
                  return videoB.play();
                }

                function startDemo() {  //need user input to play video
                        render();
                        var playPromiseF = videoF.play();

                        // In browsers that don’t yet support this functionality,
                        // playPromise won’t be defined.
                        if (playPromiseF !== undefined) {
                          playPromiseF.then(function() {
                            // Automatic playback started!
                               //console.log("Playing");
                          }).catch(function(error) {
                                console.log("Promise failed", error.name);
                            // Automatic playback failed.
                            // Show a UI element to let the user manually start playback.
                          var playButton = document.querySelector('#play2');
                          // The user interaction requirement is met if
                          // playback is triggered via a click event.
                          playButton.addEventListener('click', startPlaybackF);
                          playButton.hidden = false;
                          });
                        var playPromiseB = videoB.play();

                        // In browsers that don’t yet support this functionality,
                        // playPromise won’t be defined.
                        if (playPromiseB !== undefined) {
                          playPromiseB.then(function() {
                            // Automatic playback started!
                               //console.log("Playing");
                          }).catch(function(error) {
                                console.log("Promise failed", error.name);
                            // Automatic playback failed.
                            // Show a UI element to let the user manually start playback.
                          var playButton = document.querySelector('#play2');
                          // The user interaction requirement is met if
                          // playback is triggered via a click event.
                          playButton.addEventListener('click', startPlaybackB);
                          playButton.hidden = false;
                          });
                        }}
                        videoF.pause();
                        videoB.pause();
                        document.getElementById("startbutton").remove();     //hide button
                        if(!nosensors)
                        {
                                reading = setInterval(saveSensorReading, 1000/sensorfreq);     //start saving data from sensors in loop
                                ut = setInterval(updateText, 1000);
                        }
                }
                        function rewind() {
                               if(!rewinding)
                                {
                                        rw_div.innerHTML = "Not rewinding";
                                        time = videoF.currentTime;
                                        videoF.pause();
                                        video = videoB;
                                        videoF.pause();
                                        videoB.currentTime = videoB.duration - time;
                                        videoTexture = new THREE.Texture(videoB);
                                        videoTexture.minFilter = THREE.LinearFilter;
                                        videoTexture.magFilter = THREE.LinearFilter;
                                        videoTexture.format = THREE.RGBFormat;
                                        videoTexture.needsUpdate = true;
                                        scene.remove(sphereMesh);
                                        sphereMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: 0.5 } );
                                        sphereMesh = new THREE.Mesh(sphere, sphereMaterial);
                                        sphereMaterial.needsUpdate = true;
                                        scene.add(sphereMesh);
                                        rewinding = true;
                                        return 0;
                                        }
                                else if (rewinding)
                                {
                                        rw_div.innerHTML = "Rewinding";
                                        time = videoB.currentTime;
                                        videoB.pause();
                                        video = videoF;
                                        videoF.pause();
                                        videoF.currentTime = videoF.duration - time;
                                        videoTexture = new THREE.Texture(videoF);
                                        videoTexture.minFilter = THREE.LinearFilter;
                                        videoTexture.magFilter = THREE.LinearFilter;
                                        videoTexture.format = THREE.RGBFormat;
                                        videoTexture.needsUpdate = true;
                                        scene.remove(sphereMesh);
                                        sphereMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: 0.5 } );
                                        sphereMesh = new THREE.Mesh(sphere, sphereMaterial);
                                        sphereMaterial.needsUpdate = true;
                                        scene.add(sphereMesh);
                                        rewinding = false;
                                        return 0;
                                }
                        }
		</script>
	</body>
</html>





